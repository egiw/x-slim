{% extends template %}

{% set title = "Articles"|trans %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">
            <h1>
                {% trans %} Article {% endtrans %}
                <small>
                    {% trans %} List, add, or edit articles {% endtrans %}
                </small>
            </h1>
        </div>
        <div class="col-lg-4">
            <div class="btn-group pull-right" data-toggle="buttons" style="margin-top: 20px;">
                {% if not(_user.author or _user.contributor) %}
                    <label class="btn btn-primary">
                        <input type="radio" value="0" name="type" id="radio-all"> 
                        {% trans %} All Posts {% endtrans %}
                    </label>
                {% endif %}
                <label class="btn btn-primary active">
                    <input type="radio" value="1" name="type" id="radio-only" checked>
                    {% trans %} My Posts {% endtrans %}
                </label>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <ol class="breadcrumb">
                <li>
                    <a data-pjax href="{{ urlFor('admin.index') }}">
                        <i class="fa fa-dashboard"></i> 
                        {% trans %} Dashboard {% endtrans %}
                    </a>
                </li>
                <li class="active"><i class="fa fa-file"></i> 
                    {% trans %} Article {% endtrans %}
                </li>
            </ol>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <ul id="nav-filter-status" class="nav nav-tabs">
                <li class="pull-right">
                    <a href="#" data-toggle="tab" data-url="{{ urlFor('admin.article.datatables', {status: constant('Article::STATUS_ARCHIVE')}) }}">
                        {% trans %} Trash {% endtrans %}
                        <span id="badge-archived" class="badge badge-default"></span>
                    </a>
                </li>
                <li class="pull-right">
                    <a href="#" data-toggle="tab" data-url="{{ urlFor('admin.article.datatables', {status: constant('Article::STATUS_DRAFT')}) }}">
                        {% trans %} Draft {% endtrans %}
                        <span id="badge-draft" class="badge badge-default"></span>
                    </a>
                </li>
                <li class="pull-right">
                    <a href="#" data-toggle="tab" data-url="{{ urlFor('admin.article.datatables', {status: constant('Article::STATUS_PENDING')}) }}">
                        {% trans %} Need Review {% endtrans %}
                        <span id="badge-pending" class="badge badge-default"></span>
                    </a>
                </li>
                <li class="active pull-right">
                    <a href="#" data-toggle="tab" data-url="{{ urlFor('admin.article.datatables', {status: constant('Article::STATUS_PUBLISH')}) }}">
                        {% trans %} Published {% endtrans %}
                        <span id="badge-published" class="badge badge-default"></span>
                    </a>
                </li>
                <li>
                    <a data-pjax href="{{ urlFor('admin.article.create') }}" 
                       data-placement="left">
                        <i class="fa fa-plus"></i>
                        {% trans %} Add New {% endtrans %}
                    </a>
                </li>
            </ul>


            <table class="table table-condensed" id="tbl-article">
                <colgroup>
                    <col width="3%"/>
                    <col width="38%"/>
                    <col width="15%"/>
                    <col width="15%"/>
                    <col width="5%"/>
                    <col width="10%"/>
                </colgroup>
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>{% trans %} Title {% endtrans %}</th>
                        <th>{% trans %} Created {% endtrans %}</th>
                        <th>{% trans %} Last Update {% endtrans %}</th>
                        <th><i class="fa fa-eye"></i></th>
                        <th></th>
                    </tr>
                </thead>
            </table>
        </div><!-- /.blog-main -->
    </div>
{% endblock %}


{% block script %}
    <script type="text/javascript">
        {% set script %}
            var $tblArticle = $('#tbl-article').DataTable({
                serverSide: true,
                processing: false,
                ordering: true,
                lengthChange: true,
                ajax: {
                    url: '{{ urlFor('admin.article.datatables', {'status': constant('Article::STATUS_PUBLISH')}) }}',
                    data: function(data) {
                        data.type = $('input[name=type]:radio:checked').val();
                    }
                },
                pageLength: 10,
                order: [[3, 'desc']],
                columns: [
                    {
                        data: "group",
                        visible: false
                    },
                    {
                        class: 'details-control',
                        orderable: false,
                        data: null,
                        defaultContent: ''
                    },
                    {
                        data: "title",
                        orderable: false
                    },
                    {data: "createdAt"},
                    {data: "lastUpdate"},
                    {data: "views", orderable: false},
                    {
                        data: "control",
                        orderable: false
                    }
                ],
                drawCallback: function(settings) {
                    var api = this.api();
                    var rows = api.rows({page: 'current'}).nodes();
                    var last = null;
                    api.column(0, {page: 'current'}).data().each(function(group, i) {
                        if (last !== group) {
                            var $toolbar = this.row(i).data().toolbar;
                            $(rows).eq(i).before($toolbar);
                            last = group;
                        }
                    });
                }
            });

            // Add event listener for opening and closing details
            $tblArticle.on('click', 'td.details-control', function() {
                var tr = $(this).closest('tr');
                var row = $tblArticle.row(tr);
                var data = row.data();

                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    row.child('loading...').show();
                    tr.addClass('shown');
                    // Open this row
                    $.get(data.id, function(response) {
                        row.child(response);
                    });
                }
            });

            $("#nav-filter-status a[data-toggle='tab']")
                    .on('shown.bs.tab', function(e) {
                        $tblArticle.ajax.url($(e.target).data('url')).load();
                    });

            $('input[name=type]:radio').change(function() {

                loadCountInfo();
                $tblArticle.ajax.reload();
            });

            function _remove(url) {
                var msg = "<h4 class='text-warning'><i class='fa fa-warning'></i> {% trans %} This item will be moved to archive. Are you sure ? {% endtrans %}</h4>";
                request(url, 'put', msg);
            }

            function _restore(url) {
                var msg = "<h4 class='text-info'><i class='fa fa-info-circle'></i> {% trans %} This item will be restored. Are you sure ? {% endtrans %}</h4>";
                request(url, 'put', msg);
            }

            function _delete(url) {
                var msg = "<h4 class='text-danger'><i class='fa fa-warning'></i> {% trans %} This item will be completely deleted. Are you sure ? {% endtrans %}</h4>";
                request(url, 'delete', msg);
            }

            function _publish(url) {
                var msg = "<h4 class='text-info'><i class='fa fa-info-circle'></i> {% trans %} This item will be published. Are you sure ? {% endtrans %}</h4>";
                request(url, 'put', msg);
            }

            function _unpublish(url) {
                var msg = "<h4 class='text-info'><i class='fa fa-warning'></i> {% trans %} This item will no longer published. Are you sure ? {% endtrans %}</h4>";
                request(url, 'put', msg);
            }

            function _pending(url) {
                var msg = "<h4 class='text-info'><i class='fa fa-warning'></i> {% trans %} This item will be mark as need review. Are you sure ? {% endtrans %}</h4>";
                request(url, 'put', msg);
            }

            function request(url, method, confirmMsg) {
                bootbox.confirm(confirmMsg, function(result) {
                    if (result) {
                        $.ajax({
                            url: url,
                            type: 'post',
                            data: {_METHOD: method.toUpperCase()},
                            success: function(result) {
                                if (result) {
                                    $tblArticle.ajax.reload();
                                    loadCountInfo();
                                }
                            }
                        });
                    }
                });
            }
            (loadCountInfo = function() {
                var type = $('input[name=type]:radio:checked').val();
                $.get('{{ urlFor('admin.article.count') }}', {type: type}, function(data) {
                        $("#badge-published").text(data.publish);
                        $("#badge-draft").text(data.draft);
                        $("#badge-pending").text(data.pending);
                        $("#badge-archived").text(data.archive);
                    })
                })();
        {% endset %}
        {{ script|pack|raw }}
    </script>
{% endblock %}